name: CI/CD Pipeline - Maven ‚Üí SonarQube ‚Üí Nexus RAW ‚Üí Tomcat

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: http://52.2.192.208:9000/
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      NEXUS_URL: http://52.2.192.208:8081
      NEXUS_REPO: java   # RAW REPO
      NEXUS_USER: ${{ secrets.NEXUS_USER }}
      NEXUS_PASS: ${{ secrets.NEXUS_PASS }}

      TOMCAT_URL: http://52.2.192.208:8080/manager/text
      TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
      TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}

      ARTIFACT_NAME: onlinebookstore

    steps:

      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üß∞ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: üîç SonarQube Analysis
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=OnlineBookstore \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN} \
            -DskipTests

      - name: ‚öôÔ∏è Build WAR File
        run: |
          mvn clean package -DskipTests
          echo "WAR files found:"
          ls -lh target/*.war

      - name: ‚¨ÜÔ∏è Upload WAR to Nexus RAW Repo
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"
          FILE_NAME="${ARTIFACT_NAME}-${VERSION}.war"

          echo "üì§ Uploading WAR ‚Üí Nexus RAW repo..."
          echo "Uploading as: $FILE_NAME"

          curl -v -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "$WAR_FILE" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${FILE_NAME}"

          echo "‚úÖ WAR uploaded successfully!"

      - name: ‚¨áÔ∏è Download Latest WAR from RAW Nexus (HTML Scraping FIX)
        run: |
          set -e
          echo "üîç Searching RAW repo for latest WAR‚Ä¶"

          LATEST_WAR=$(curl -s "${NEXUS_URL}/repository/${NEXUS_REPO}/" \
            | grep -oP "${ARTIFACT_NAME}-[0-9\.]+\.war" \
            | sort -V \
            | tail -1)

          if [[ -z "$LATEST_WAR" ]]; then
            echo "‚ùå No WAR found in RAW Nexus repo!"
            exit 1
          fi

          echo "üì¶ Latest WAR found: $LATEST_WAR"

          FULL_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${LATEST_WAR}"

          echo "‚¨áÔ∏è Downloading: $FULL_URL"
          curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$FULL_URL"

          echo "Downloaded WAR file: $LATEST_WAR"

      - name: üöÄ Deploy WAR to Tomcat
        run: |
          set -e
          APP_NAME=${ARTIFACT_NAME}

          echo "üßπ Undeploying old version..."
          curl -u ${TOMCAT_USER}:${TOMCAT_PASS} \
            "${TOMCAT_URL}/undeploy?path=/${APP_NAME}" || true
          sleep 5

          echo "üöÄ Deploying new WAR to Tomcat..."
          curl -u ${TOMCAT_USER}:${TOMCAT_PASS} \
            --upload-file "${LATEST_WAR}" \
            "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"

          echo "‚úÖ Deployment completed!"

      - name: üîé Verify Deployment
        run: |
          APP_URL="http://52.2.192.208:8080/${ARTIFACT_NAME}/"
          echo "‚è≥ Waiting for app to come online..."
          sleep 30

          STATUS=$(curl -m 20 -o /dev/null -s -w "%{http_code}" "$APP_URL")

          if [ "$STATUS" -eq 200 ]; then
            echo "‚úÖ Application is LIVE at: $APP_URL"
          else
            echo "‚ùå Deployment failed! HTTP Status: $STATUS"
            exit 1
          fi
