name: CI/CD Pipeline - Maven ‚Üí Nexus RAW ‚Üí Tomcat

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      RAW_REPO_URL: http://52.2.192.208:8081/repository/java/
      TOMCAT_URL: http://54.163.54.210:8080/manager/text

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: üß∞ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: ‚öôÔ∏è Build WAR File
        run: |
          mvn clean package -DskipTests
          ls -lh target/*.war

      - name: ‚¨ÜÔ∏è Upload WAR to Nexus RAW Repository
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"
          DEST="onlinebookstore-${VERSION}.war"

          echo "üì§ Uploading WAR ‚Üí RAW repo..."
          curl -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "$WAR_FILE" \
            "${RAW_REPO_URL}${DEST}"

          echo "‚úÖ WAR uploaded successfully!"

      - name: ‚¨áÔ∏è Fetch Latest WAR From RAW Nexus Repo
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          echo "üîç Searching RAW repo for latest WAR‚Ä¶"

          curl -s ${RAW_REPO_URL} -u ${NEXUS_USER}:${NEXUS_PASS} -o list.html

          LATEST=$(grep -oP 'onlinebookstore-[0-9\.]+\.war' list.html | sort -V | tail -1)

          if [ -z "$LATEST" ]; then
            echo "‚ùå No WAR found in RAW Nexus repo!"
            exit 1
          fi

          echo "üìå Latest WAR = $LATEST"

          curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "${RAW_REPO_URL}${LATEST}"

      - name: üöÄ Deploy WAR to Tomcat
        env:
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}
        run: |
          APP_NAME="onlinebookstore"
          WAR_FILE=$(ls onlinebookstore-*.war | head -1)

          echo "üßπ Removing old deployment..."
          curl -u "${TOMCAT_USER}:${TOMCAT_PASS}" \
            "${TOMCAT_URL}/undeploy?path=/${APP_NAME}" || true
          
          sleep 5

          echo "üöÄ Deploying new WAR..."
          curl -u "${TOMCAT_USER}:${TOMCAT_PASS}" \
            --upload-file "$WAR_FILE" \
            "${TOMCAT_URL}/deploy?path=/${APP_NAME}&update=true"

          echo "‚úÖ Deployment finished!"

      - name: üîé Verify Deployment
        run: |
          APP_URL="http://54.163.54.210:8080/onlinebookstore/"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$APP_URL")

          echo "HTTP Status: $STATUS"
          if [ "$STATUS" -eq 200 ]; then
            echo "üéâ App is LIVE!"
          else
            echo "‚ùå Application did not start correctly."
            exit 1
          fi
