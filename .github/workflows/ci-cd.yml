name: CI/CD Pipeline - Maven ‚Üí SonarQube ‚Üí Nexus ‚Üí EC2 SSH Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: http://52.2.192.208:9000/
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      NEXUS_URL: http://52.2.192.208:8081
      NEXUS_REPO: maven-releases
      NEXUS_GROUP: com/app/onlinebookstore
      NEXUS_ARTIFACT: onlinebookstore

    steps:
      # ---------------- CHECKOUT ----------------
      - name: üì¶ Checkout Source Code
        uses: actions/checkout@v4

      # ---------------- JAVA SETUP ----------------
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üß∞ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ---------------- SONARQUBE ANALYSIS ----------------
      - name: üîç SonarQube Analysis
        run: |
          mvn clean verify sonar:sonar \
            -DskipTests \
            -Dsonar.projectKey=OnlineBookstore \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      # ---------------- BUILD WAR ----------------
      - name: ‚öôÔ∏è Build WAR File
        run: |
          mvn clean package -DskipTests
          echo "WAR Generated:"
          ls -lh target/*.war

      # ---------------- UPLOAD TO NEXUS ----------------
      - name: ‚¨ÜÔ∏è Upload WAR to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"

          echo "üì¶ Uploading $WAR_FILE to Nexus as version $VERSION ..."
          curl -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "$WAR_FILE" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.war"

          echo "‚úÖ Uploaded successfully!"

      # ---------------- EC2 SSH DEPLOYMENT ----------------
      - name: üîê Setup SSH Key for EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: üöÄ Deploy WAR to EC2 Server via SSH
        env:
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          set -e

          echo "üîç Fetching latest WAR from Nexus..."

          DOWNLOAD_URL=$(curl -s -u ${NEXUS_USER}:${NEXUS_PASS} \
            "${NEXUS_URL}/service/rest/v1/search/assets?repository=${NEXUS_REPO}" \
            | grep -oP '"downloadUrl"\s*:\s*"[^"]*onlinebookstore-[0-9.]+\.war' \
            | tail -1 | cut -d'"' -f4)

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "‚ùå No WAR found in Nexus!"
            exit 1
          fi

          echo "‚¨áÔ∏è Downloading WAR: $DOWNLOAD_URL"
          curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$DOWNLOAD_URL"
          WAR_FILE=$(basename "$DOWNLOAD_URL")

          echo "üì° Copying WAR to EC2..."
          scp -o StrictHostKeyChecking=no -i ec2_key.pem "$WAR_FILE" \
            ${EC2_USER}@${EC2_HOST}:/tmp/

          echo "üì¶ Deploying WAR on EC2 Tomcat..."
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            sudo systemctl stop tomcat || true
            sudo rm -rf /opt/tomcat/webapps/onlinebookstore*
            sudo mv /tmp/onlinebookstore-*.war /opt/tomcat/webapps/onlinebookstore.war
            sudo systemctl start tomcat
            echo "üöÄ Tomcat restarted and WAR deployed!"
          EOF

      # ---------------- VERIFY DEPLOYMENT ----------------
      - name: üîé Verify Application Deployment
        run: |
          echo "‚è≥ Waiting for Tomcat to deploy WAR..."
          sleep 40

          APP_URL="http://${{ secrets.EC2_HOST }}:8080/onlinebookstore/"
          STATUS=$(curl -m 15 -o /dev/null -s -w "%{http_code}" "$APP_URL")

          echo "HTTP Response Code: $STATUS"

          if [ "$STATUS" -eq 200 ]; then
              echo "‚úÖ Deployment successful & app is live!"
          else
              echo "‚ùå App did not respond with 200 OK"
              exit 1
          fi
