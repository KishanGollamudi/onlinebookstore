name: CI/CD Pipeline - Maven ‚Üí SonarQube ‚Üí RAW Nexus ‚Üí Tomcat

on:
  push:
    branches: 
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: http://52.2.192.208:9000/
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      NEXUS_URL: http://52.2.192.208:8081
      NEXUS_REPO: java  # RAW repo name

      TOMCAT_URL: http://52.2.192.208:8080/manager/text

    steps:

      # ------------------------
      #  CHECKOUT
      # ------------------------
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      # ------------------------
      #  JAVA
      # ------------------------
      - name: ‚òï Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: üß∞ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ------------------------
      #  SONARQUBE
      # ------------------------
      - name: üîç SonarQube Code Analysis
        run: |
          mvn clean verify sonar:sonar \
            -DskipTests \
            -Dsonar.projectKey=OnlineBookstore \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      # ------------------------
      #  BUILD WAR
      # ------------------------
      - name: ‚öôÔ∏è Build WAR Package
        run: |
          mvn clean package -DskipTests
          echo "WAR file created:"
          ls -lh target/*.war

      # ------------------------
      #  UPLOAD TO NEXUS (RAW HOSTED)
      # ------------------------
      - name: ‚¨ÜÔ∏è Upload WAR to Nexus RAW Repo
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"

          echo "Uploading $WAR_FILE to RAW Nexus Repo..."

          curl -v -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "$WAR_FILE" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/onlinebookstore-${VERSION}.war"

          echo "WAR uploaded successfully!"

      # ------------------------
      #  DOWNLOAD LATEST WAR ‚Üí DEPLOY TO TOMCAT
      # ------------------------
      - name: üöÄ Deploy WAR to Tomcat Server
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}
        run: |
          set -e

          echo "üîç Searching RAW repo for latest WAR‚Ä¶"

          DOWNLOAD_URL=$(curl -s -u ${NEXUS_USER}:${NEXUS_PASS} \
             "${NEXUS_URL}/service/rest/v1/search/assets?repository=${NEXUS_REPO}" \
             | grep -oP '"downloadUrl"\s*:\s*"[^"]*onlinebookstore-[0-9.]+' \
             | tail -1 | cut -d'"' -f4 )

          if [[ -z "$DOWNLOAD_URL" ]]; then
            echo "‚ùå No WAR found in RAW Nexus repo!"
            exit 1
          fi

          echo "‚¨áÔ∏è Downloading WAR: $DOWNLOAD_URL"
          curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$DOWNLOAD_URL"
          WAR_FILE=$(basename "$DOWNLOAD_URL")

          echo "üßπ Cleaning previous deployment..."
          curl -u ${TOMCAT_USER}:${TOMCAT_PASS} \
            "${TOMCAT_URL}/undeploy?path=/onlinebookstore" || true

          echo "üöÄ Deploying new WAR..."
          curl -u ${TOMCAT_USER}:${TOMCAT_PASS} \
            --upload-file "$WAR_FILE" \
            "${TOMCAT_URL}/deploy?path=/onlinebookstore&update=true"

          echo "Deployment completed."

      # ------------------------
      #  VERIFY DEPLOYMENT
      # ------------------------
      - name: üîé Verify App Deployment
        run: |
          APP_URL="http://52.2.192.208:8080/onlinebookstore/"

          echo "‚è≥ Waiting 60s for Tomcat to finish deployment..."
          sleep 60

          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$APP_URL")

          if [ "$STATUS" == "200" ]; then
            echo "‚úÖ App is LIVE at: $APP_URL"
          else
            echo "‚ùå Deployment failed. Status: $STATUS"
            exit 1
          fi

          echo "üéâ Deployment Verified Successfully!"
