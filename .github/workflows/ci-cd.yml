name: CI/CD Pipeline - Maven ‚Üí SonarQube ‚Üí Nexus ‚Üí Tomcat

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: "http://52.2.192.208:9000"
      NEXUS_URL: "http://52.2.192.208:8081"
      NEXUS_REPO: "maven-releases"
      NEXUS_GROUP: "com/app/onlinebookstore"
      ARTIFACT_ID: "onlinebookstore"
      TOMCAT_HOST: "54.163.54.210"
      TOMCAT_PORT: "8080"

    steps:

      # ---------------------------------
      # üì¶ Checkout Code
      # ---------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------
      # ‚òï Setup Java 17
      # ---------------------------------
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ---------------------------------
      # üß∞ Cache Maven
      # ---------------------------------
      - name: Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ---------------------------------
      # üîç SonarQube Scan
      # ---------------------------------
      - name: SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=OnlineBookstore \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      # ---------------------------------
      # ‚öôÔ∏è Build WAR File
      # ---------------------------------
      - name: Build WAR Package
        run: |
          mvn clean package -DskipTests
          echo "WAR generated:"
          ls -lh target/*.war

      # ---------------------------------
      # üì§ Upload WAR to Nexus
      # ---------------------------------
      - name: Upload WAR to Nexus Repository
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="1.0.${{ github.run_number }}"
          echo "Uploading WAR version = $VERSION"
          
          curl -v -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "$WAR_FILE" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.war"

      # ---------------------------------
      # üöÄ Deploy WAR to Tomcat
      # ---------------------------------
      - name: Deploy WAR to Tomcat
        env:
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_PASS: ${{ secrets.TOMCAT_PASS }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          set -e
          APP_NAME="onlinebookstore"
          MANAGEMENT_URL="http://${TOMCAT_USER}:${TOMCAT_PASS}@${TOMCAT_HOST}:${TOMCAT_PORT}/manager/text"

          echo "Finding latest WAR in Nexus..."
          DOWNLOAD_URL=$(curl -s -u ${NEXUS_USER}:${NEXUS_PASS} \
            "${NEXUS_URL}/service/rest/v1/search/assets?repository=${NEXUS_REPO}&maven.groupId=com.app.onlinebookstore" \
            | grep -oP '"downloadUrl"\s*:\s*"[^"]+\.war"' | tail -1 | cut -d'"' -f4)

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "ERROR: No WAR found in Nexus"
            exit 1
          fi

          echo "Downloading WAR ‚Üí $DOWNLOAD_URL"
          curl -u ${NEXUS_USER}:${NEXUS_PASS} -O "$DOWNLOAD_URL"

          WAR_FILE=$(basename "$DOWNLOAD_URL")

          echo "Undeploying old app..."
          curl -s "${MANAGEMENT_URL}/undeploy?path=/${APP_NAME}" || true

          echo "Deploying new WAR..."
          curl -s -T "$WAR_FILE" "${MANAGEMENT_URL}/deploy?path=/${APP_NAME}&update=true"

      # ---------------------------------
      # üîé Verify Deployment
      # ---------------------------------
      - name: Verify Deployment
        run: |
          APP_URL="http://${TOMCAT_HOST}:${TOMCAT_PORT}/onlinebookstore/"
          echo "Waiting for application to start..."
          sleep 40

          STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$APP_URL")

          if [ "$STATUS" -eq 200 ]; then
            echo "üöÄ SUCCESS! Application is live ‚Üí $APP_URL"
          else
            echo "‚ùå Deployment failed. HTTP $STATUS"
            exit 1
